<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYMBIOSE AI Interceptor - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: 100vh;
            gap: 0;
        }

        /* Left Panel - Monitoring */
        .monitor-panel {
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00d9ff, #0066ff);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #00d9ff, #0066ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 0.8rem;
            color: #888;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00d9ff;
        }

        .stat-value.warning { color: #ffaa00; }
        .stat-value.danger { color: #ff4444; }
        .stat-value.success { color: #00ff88; }

        /* Providers */
        .providers-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .providers-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .provider-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s;
        }

        .provider-card:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-2px);
        }

        .provider-card.active {
            border-color: #00d9ff;
            box-shadow: 0 0 20px rgba(0,217,255,0.2);
        }

        .provider-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .provider-name {
            font-size: 0.7rem;
            color: #aaa;
        }

        .provider-count {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00d9ff;
        }

        /* Intercepts List */
        .intercepts-section {
            flex: 1;
        }

        .intercepts-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .intercept-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 12px 15px;
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: 15px;
            align-items: center;
            transition: all 0.2s;
        }

        .intercept-item:hover {
            background: rgba(255,255,255,0.06);
        }

        .intercept-provider {
            font-weight: 600;
            color: #00d9ff;
            min-width: 80px;
        }

        .intercept-model {
            color: #aaa;
            font-size: 0.85rem;
        }

        .intercept-latency {
            font-family: monospace;
            color: #00ff88;
        }

        .intercept-latency.slow { color: #ffaa00; }
        .intercept-latency.very-slow { color: #ff4444; }

        .intercept-tokens {
            font-size: 0.8rem;
            color: #888;
        }

        .intercept-time {
            font-size: 0.75rem;
            color: #666;
        }

        /* Right Panel - Chat */
        .chat-panel {
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.3);
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-title {
            font-size: 1rem;
            color: #00d9ff;
        }

        .chat-status {
            margin-left: auto;
            font-size: 0.75rem;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 12px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message.user {
            background: linear-gradient(135deg, #0066ff, #0044cc);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.assistant {
            background: rgba(255,255,255,0.1);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message.system {
            background: rgba(0,217,255,0.1);
            border: 1px solid rgba(0,217,255,0.3);
            align-self: center;
            font-size: 0.8rem;
            color: #00d9ff;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 0.75rem;
            color: #888;
        }

        .message-ia {
            background: linear-gradient(90deg, #00d9ff, #0066ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .ia-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .ia-btn {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent;
            color: #aaa;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ia-btn:hover {
            border-color: #00d9ff;
            color: #00d9ff;
        }

        .ia-btn.active {
            background: linear-gradient(135deg, #00d9ff, #0066ff);
            border-color: transparent;
            color: #fff;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s;
        }

        .chat-input:focus {
            border-color: #00d9ff;
            box-shadow: 0 0 20px rgba(0,217,255,0.2);
        }

        .send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #00d9ff, #0066ff);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0,217,255,0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Voice buttons */
        .voice-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: #aaa;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .voice-btn:hover {
            border-color: #00d9ff;
            color: #00d9ff;
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            border-color: #ff4444;
            color: #fff;
            animation: recording-pulse 1s infinite;
        }

        .voice-btn.speaking {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            border-color: #00ff88;
            color: #fff;
        }

        @keyframes recording-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255,68,68,0.4); }
            50% { box-shadow: 0 0 20px 10px rgba(255,68,68,0.2); }
        }

        .message .listen-btn {
            background: none;
            border: none;
            color: #00d9ff;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 8px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .message .listen-btn:hover {
            opacity: 1;
        }

        .voice-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: #ff4444;
            margin-bottom: 5px;
        }

        .voice-indicator .waves {
            display: flex;
            gap: 2px;
        }

        .voice-indicator .wave {
            width: 3px;
            height: 15px;
            background: #ff4444;
            border-radius: 2px;
            animation: wave 0.5s ease-in-out infinite;
        }

        .voice-indicator .wave:nth-child(2) { animation-delay: 0.1s; }
        .voice-indicator .wave:nth-child(3) { animation-delay: 0.2s; }
        .voice-indicator .wave:nth-child(4) { animation-delay: 0.3s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel - Monitoring -->
        <div class="monitor-panel">
            <div class="header">
                <div class="logo">üîç</div>
                <div>
                    <h1>SYMBIOSE AI Interceptor</h1>
                    <div class="subtitle">Real-time AI API Monitoring</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Intercepts</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Latency</div>
                    <div class="stat-value" id="stat-latency">0<span style="font-size:0.8rem">ms</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Est. Cost</div>
                    <div class="stat-value success" id="stat-cost">$0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Errors</div>
                    <div class="stat-value" id="stat-errors">0</div>
                </div>
            </div>

            <div class="providers-section">
                <div class="section-title">AI Providers</div>
                <div class="providers-grid">
                    <div class="provider-card active" data-provider="openai">
                        <div class="provider-icon">ü§ñ</div>
                        <div class="provider-name">OpenAI</div>
                        <div class="provider-count" id="count-openai">0</div>
                    </div>
                    <div class="provider-card" data-provider="anthropic">
                        <div class="provider-icon">üß†</div>
                        <div class="provider-name">Anthropic</div>
                        <div class="provider-count" id="count-anthropic">0</div>
                    </div>
                    <div class="provider-card" data-provider="google">
                        <div class="provider-icon">‚ú®</div>
                        <div class="provider-name">Google</div>
                        <div class="provider-count" id="count-google">0</div>
                    </div>
                    <div class="provider-card" data-provider="cohere">
                        <div class="provider-icon">üîÆ</div>
                        <div class="provider-name">Cohere</div>
                        <div class="provider-count" id="count-cohere">0</div>
                    </div>
                    <div class="provider-card" data-provider="huggingface">
                        <div class="provider-icon">ü§ó</div>
                        <div class="provider-name">HuggingFace</div>
                        <div class="provider-count" id="count-huggingface">0</div>
                    </div>
                </div>
            </div>

            <div class="intercepts-section">
                <div class="section-title">Recent Intercepts</div>
                <div class="intercepts-list" id="intercepts-list">
                    <div class="intercept-item">
                        <span class="intercept-provider">OpenAI</span>
                        <span class="intercept-model">gpt-4-turbo</span>
                        <span class="intercept-latency">1,234ms</span>
                        <span class="intercept-tokens">‚Üì1.2k ‚Üë0.8k</span>
                        <span class="intercept-time">12:34:56</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Chat -->
        <div class="chat-panel">
            <div class="chat-header">
                <span>üí¨</span>
                <span class="chat-title">Multi-IA Chat</span>
                <div class="chat-status">
                    <div class="status-dot"></div>
                    <span>Connected</span>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="message system">
                    Bienvenue! Selectionnez une IA et posez votre question.
                </div>
            </div>

            <div class="chat-input-container">
                <div class="ia-selector">
                    <button class="ia-btn active" data-ia="lmstudio">LM Studio</button>
                    <button class="ia-btn" data-ia="gemini">Gemini</button>
                    <button class="ia-btn" data-ia="perplexity">Perplexity</button>
                    <button class="ia-btn" data-ia="all">Consensus</button>
                </div>
                <div id="voice-indicator" class="voice-indicator" style="display:none;">
                    <div class="waves">
                        <div class="wave"></div>
                        <div class="wave"></div>
                        <div class="wave"></div>
                        <div class="wave"></div>
                    </div>
                    <span>Enregistrement en cours...</span>
                </div>
                <div class="chat-input-wrapper">
                    <button class="voice-btn" id="mic-btn" title="Enregistrer un message vocal">üé§</button>
                    <input type="text" class="chat-input" id="chat-input" placeholder="Posez votre question..." />
                    <button class="voice-btn" id="listen-btn" title="Ecouter le dernier message">üîä</button>
                    <button class="send-btn" id="send-btn">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            LM_STUDIO_URL: 'http://192.168.1.85:1234',
            WS_URL: 'ws://localhost:3001',
            API_URL: 'http://localhost:3000/api'
        };

        // State
        let selectedIA = 'lmstudio';
        let stats = { total: 0, byProvider: {}, avgLatency: 0, errors: 0, cost: 0 };
        let intercepts = [];

        // WebSocket connection
        let ws;
        function connectWebSocket() {
            ws = new WebSocket(CONFIG.WS_URL);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateStatus(true);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleIntercept(data);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected, reconnecting...');
                updateStatus(false);
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
            };
        }

        function updateStatus(connected) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.querySelector('.chat-status span');

            if (connected) {
                statusDot.style.background = '#00ff88';
                statusText.textContent = 'Connected';
            } else {
                statusDot.style.background = '#ff4444';
                statusText.textContent = 'Disconnected';
            }
        }

        // Handle incoming intercept
        function handleIntercept(data) {
            // Update stats
            stats.total++;
            stats.byProvider[data.provider] = (stats.byProvider[data.provider] || 0) + 1;
            stats.avgLatency = Math.round(
                (stats.avgLatency * (stats.total - 1) + data.latency) / stats.total
            );
            stats.cost += data.cost || 0;

            // Add to intercepts list
            intercepts.unshift(data);
            if (intercepts.length > 100) intercepts.pop();

            // Update UI
            updateStatsUI();
            updateInterceptsUI();
        }

        function updateStatsUI() {
            document.getElementById('stat-total').textContent = stats.total.toLocaleString();
            document.getElementById('stat-latency').innerHTML =
                `${stats.avgLatency.toLocaleString()}<span style="font-size:0.8rem">ms</span>`;
            document.getElementById('stat-cost').textContent = `$${stats.cost.toFixed(2)}`;
            document.getElementById('stat-errors').textContent = stats.errors;

            // Update provider counts
            ['openai', 'anthropic', 'google', 'cohere', 'huggingface'].forEach(p => {
                const el = document.getElementById(`count-${p}`);
                if (el) el.textContent = stats.byProvider[p] || 0;
            });
        }

        function updateInterceptsUI() {
            const list = document.getElementById('intercepts-list');
            list.innerHTML = intercepts.slice(0, 20).map(i => {
                const latencyClass = i.latency > 5000 ? 'very-slow' : (i.latency > 2000 ? 'slow' : '');
                const time = new Date(i.timestamp).toLocaleTimeString();
                return `
                    <div class="intercept-item">
                        <span class="intercept-provider">${i.provider}</span>
                        <span class="intercept-model">${i.model}</span>
                        <span class="intercept-latency ${latencyClass}">${i.latency.toLocaleString()}ms</span>
                        <span class="intercept-tokens">‚Üì${formatTokens(i.tokens?.input)} ‚Üë${formatTokens(i.tokens?.output)}</span>
                        <span class="intercept-time">${time}</span>
                    </div>
                `;
            }).join('');
        }

        function formatTokens(n) {
            if (!n) return '0';
            if (n >= 1000) return (n/1000).toFixed(1) + 'k';
            return n.toString();
        }

        // IA Selector
        document.querySelectorAll('.ia-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.ia-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedIA = btn.dataset.ia;
            });
        });

        // Chat functionality
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatMessages = document.getElementById('chat-messages');

        function addMessage(content, type = 'assistant', ia = null) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.dataset.content = content;

            if (ia && type === 'assistant') {
                msg.innerHTML = `
                    <div class="message-header">
                        <span class="message-ia">${ia}</span>
                        <button class="listen-btn" onclick="speakText(this.closest('.message').dataset.content)" title="Ecouter">üîä</button>
                    </div>
                    ${content}
                `;
                // Auto-speak if enabled
                if (autoSpeak) {
                    setTimeout(() => speakText(content), 100);
                }
            } else {
                msg.innerHTML = `${content} ${type !== 'system' ? '<button class="listen-btn" onclick="speakText(this.closest(\'.message\').dataset.content)" title="Ecouter">üîä</button>' : ''}`;
            }

            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            lastMessage = content;
        }

        // Voice recognition (Speech-to-Text)
        let recognition = null;
        let isRecording = false;

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'fr-FR';

                recognition.onstart = () => {
                    isRecording = true;
                    micBtn.classList.add('recording');
                    voiceIndicator.style.display = 'flex';
                    chatInput.placeholder = 'Parlez maintenant...';
                };

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    chatInput.value = transcript;
                };

                recognition.onend = () => {
                    isRecording = false;
                    micBtn.classList.remove('recording');
                    voiceIndicator.style.display = 'none';
                    chatInput.placeholder = 'Posez votre question...';

                    // Auto-send if we have text
                    if (chatInput.value.trim()) {
                        sendMessage();
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    isRecording = false;
                    micBtn.classList.remove('recording');
                    voiceIndicator.style.display = 'none';
                    chatInput.placeholder = 'Posez votre question...';

                    if (event.error === 'not-allowed') {
                        addMessage('Microphone non autorise. Verifiez les permissions.', 'system');
                    }
                };

                return true;
            }
            return false;
        }

        function toggleRecording() {
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    addMessage('Reconnaissance vocale non supportee par ce navigateur.', 'system');
                    return;
                }
            }

            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        // Text-to-Speech
        let autoSpeak = false;
        let lastMessage = '';
        let currentUtterance = null;

        function speakText(text) {
            if ('speechSynthesis' in window) {
                // Stop current speech
                if (currentUtterance) {
                    speechSynthesis.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fr-FR';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;

                // Find French voice
                const voices = speechSynthesis.getVoices();
                const frVoice = voices.find(v => v.lang.startsWith('fr')) || voices[0];
                if (frVoice) utterance.voice = frVoice;

                utterance.onstart = () => {
                    listenBtn.classList.add('speaking');
                };

                utterance.onend = () => {
                    listenBtn.classList.remove('speaking');
                    currentUtterance = null;
                };

                currentUtterance = utterance;
                speechSynthesis.speak(utterance);
            } else {
                addMessage('Synthese vocale non supportee par ce navigateur.', 'system');
            }
        }

        function stopSpeaking() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                listenBtn.classList.remove('speaking');
            }
        }

        // Load voices
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => {
                console.log('Voices loaded:', speechSynthesis.getVoices().length);
            };
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            chatInput.value = '';
            sendBtn.disabled = true;

            try {
                if (selectedIA === 'all') {
                    // Consensus - query all IAs
                    addMessage('Interrogation de toutes les IAs...', 'system');

                    const results = await Promise.allSettled([
                        queryLMStudio(text),
                        queryGemini(text)
                    ]);

                    results.forEach((r, i) => {
                        const ia = ['LM Studio', 'Gemini'][i];
                        if (r.status === 'fulfilled') {
                            addMessage(r.value, 'assistant', ia);
                        } else {
                            addMessage(`Erreur: ${r.reason}`, 'assistant', ia);
                        }
                    });
                } else {
                    let response;
                    switch (selectedIA) {
                        case 'lmstudio':
                            response = await queryLMStudio(text);
                            addMessage(response, 'assistant', 'LM Studio');
                            break;
                        case 'gemini':
                            response = await queryGemini(text);
                            addMessage(response, 'assistant', 'Gemini');
                            break;
                        case 'perplexity':
                            response = await queryPerplexity(text);
                            addMessage(response, 'assistant', 'Perplexity');
                            break;
                    }
                }
            } catch (err) {
                addMessage(`Erreur: ${err.message}`, 'system');
            }

            sendBtn.disabled = false;
        }

        async function queryLMStudio(prompt) {
            const response = await fetch(`${CONFIG.LM_STUDIO_URL}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'qwen/qwen3-30b-a3b-2507',
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 500,
                    temperature: 0.7
                })
            });

            const data = await response.json();

            // Record intercept
            handleIntercept({
                provider: 'lmstudio',
                model: 'qwen3-30b',
                latency: Math.random() * 2000 + 500,
                tokens: { input: prompt.length / 4, output: data.choices?.[0]?.message?.content?.length / 4 || 0 },
                status: 200,
                timestamp: new Date().toISOString()
            });

            return data.choices?.[0]?.message?.content || 'Pas de reponse';
        }

        async function queryGemini(prompt) {
            // Simulate Gemini (would need real API)
            return new Promise((resolve) => {
                setTimeout(() => {
                    handleIntercept({
                        provider: 'google',
                        model: 'gemini-pro',
                        latency: Math.random() * 1500 + 300,
                        tokens: { input: prompt.length / 4, output: 100 },
                        status: 200,
                        timestamp: new Date().toISOString()
                    });
                    resolve('Reponse Gemini simulee. Configurez GEMINI_API_KEY pour activer.');
                }, 1000);
            });
        }

        async function queryPerplexity(prompt) {
            // Simulate Perplexity
            return new Promise((resolve) => {
                setTimeout(() => {
                    handleIntercept({
                        provider: 'perplexity',
                        model: 'pplx-online',
                        latency: Math.random() * 2000 + 500,
                        tokens: { input: prompt.length / 4, output: 150 },
                        status: 200,
                        timestamp: new Date().toISOString()
                    });
                    resolve('Reponse Perplexity simulee. Configurez PERPLEXITY_API_KEY pour activer.');
                }, 1500);
            });
        }

        // Voice button references
        const micBtn = document.getElementById('mic-btn');
        const listenBtn = document.getElementById('listen-btn');
        const voiceIndicator = document.getElementById('voice-indicator');

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        micBtn.addEventListener('click', toggleRecording);
        listenBtn.addEventListener('click', () => {
            if (speechSynthesis.speaking) {
                stopSpeaking();
            } else if (lastMessage) {
                speakText(lastMessage);
            }
        });

        // Initialize
        connectWebSocket();

        // Fetch initial stats
        fetch(`${CONFIG.API_URL}/stats`)
            .then(r => r.json())
            .then(data => {
                stats = { ...stats, ...data };
                updateStatsUI();
            })
            .catch(() => console.log('API not available, using local stats'));

        // Demo data
        setTimeout(() => {
            ['openai', 'anthropic', 'google'].forEach((provider, i) => {
                setTimeout(() => {
                    handleIntercept({
                        provider,
                        model: provider === 'openai' ? 'gpt-4' : (provider === 'anthropic' ? 'claude-3' : 'gemini-pro'),
                        latency: Math.random() * 2000 + 500,
                        tokens: { input: 500, output: 300 },
                        status: 200,
                        timestamp: new Date().toISOString()
                    });
                }, i * 500);
            });
        }, 1000);
    </script>
</body>
</html>
